imports:
    - { resource: services/controllers.yml }
    - { resource: services/rest_handlers.yml }

services:
    kernel.listener.responseConverter:
        class: AppBundle\EventListener\RestInputOuputFormatter
        arguments: [ "@jms_serializer", "@logger", ["json"], "json", "%kernel.debug%" ]
        public: true
        tags:
            - { name: kernel.event_listener, event: kernel.view, method: onKernelView }            
            - { name: kernel.event_listener, event: kernel.exception, method: onKernelException }      
            - { name: kernel.event_listener, event: kernel.request, method: onKernelRequest }      
    em:
        alias: doctrine.orm.entity_manager
        public: true

    doctrine.listener:
        class: AppBundle\EventListener\DoctrineListener
        tags:
            - { name: doctrine.event_listener, event: prePersist, method: prePersist }
            - { name: doctrine.event_listener, event: preRemove, method: preRemove }

    opg_digideps.casrec_verification_service:
        class: AppBundle\Service\CasrecVerificationService
        arguments: [ "@em" ]

    user_registration_service:
        class: AppBundle\Service\UserRegistrationService
        arguments: [ "@em", "@opg_digideps.casrec_verification_service" ]

    org_service:
        class: AppBundle\Service\OrgService
        arguments: [ "@em", "@logger"]

    user_service:
        class: AppBundle\Service\UserService
        arguments: [ "@em", "@org_service"]

    monolog.processor.add_request_id:
        class: AppBundle\Service\RequestIdLoggerProcessor
        arguments:  [ "@service_container" ]
        tags:
              - { name: monolog.processor, method: processRecord }

    casrec_service:
        class: AppBundle\Service\CasrecService
        arguments: [ "@em", "@logger", "@opg_digideps.report_service", "@validator" ]
        public: true

    opg_digideps.report_service:
        class: AppBundle\Service\ReportService
        arguments:
          - "@em"
        public: true

    gedmo.listener.softdeleteable:
      class: Gedmo\SoftDeleteable\SoftDeleteableListener
      tags:
        - { name: doctrine.event_subscriber, connection: default }
      calls:
        - [ setAnnotationReader, [ "@annotation_reader" ] ]

    gedmo.listener.timestampable:
        class: Gedmo\Timestampable\TimestampableListener
        tags:
            - { name: doctrine.event_subscriber, connection: default }
        calls:
            - [ setAnnotationReader, [ "@annotation_reader" ] ]

    app.transformer.report_submission.report_submission_summary_transformer:
        class: AppBundle\Transformer\ReportSubmission\ReportSubmissionSummaryTransformer
        public: true
        arguments: [ '@app.service.date_time_provider' ]

    app.service.date_time_provider:
        class: AppBundle\Service\DateTimeProvider
        public: true
